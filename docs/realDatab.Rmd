---
title: "Case study: antibody interaction networks in MADI"
author: "Jie Zhou"
date: "2025-07-10"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(matrixcalc)
library(RCy3)
library(igraph)
library(fake)
library(tidyr)
library(devtools)
load_all()
load("/Users/f003r0s/Desktop/Anne_lab_projects/lglassoProject/data/b_set.Rdata")
variables=c("subject_accession","visit_name","feature","value_reported","infant_arm","delivery_mode","arm_name")
data=data_extra[,variables]
set.seed(1)
```

## data


```{r}
 wideData=reshape(data=data,idvar =  c("subject_accession","visit_name","infant_arm","delivery_mode","arm_name"),
                  timevar = "feature", direction = "wide")

#wideData=wideData[,-c(3:5)]
timepoints=ifelse(wideData$visit_name=="prevaccinated",2,ifelse(wideData$visit_name=="mo4",4,ifelse(wideData$visit_name=="vaccinated",5,9)))
wideData$visit_name=timepoints
wideData=wideData[order(wideData$subject_accession,wideData$visit_name),]

```

## homogeneous subjects

###  one-stage model (post vaccination data)

```{r}
index=which(wideData$visit_name<3)
postdata=wideData[-index,]
index=which(is.na(postdata),arr.ind = T)
aa=as.numeric(names(which(table(index[,2])>0.1*nrow(postdata))))
postdata=postdata[,-aa]
index=which(is.na(postdata),arr.ind = T)
for (i in 1:nrow(index)) {
  postdata[index[i,1],index[i,2]]=0
}
postdata[,-c(1:5)]=log10(1+postdata[,-c(1:5)])
group=ifelse(postdata$visit_name==2,1,2)
aa1=lglasso(data=postdata[,-c(3:5)],lambda = 0.004961126,random = FALSE)
aa1$wi[[1]][1:10,1:10]
```


### two-stage model (full data)

```{r}
index=which(is.na(wideData),arr.ind = T)
aa=as.numeric(names(which(table(index[,2])>0.1*nrow(wideData))))
fulldata=wideData[,-aa]
index=which(is.na(fulldata),arr.ind = T)
for (i in 1:nrow(index)) {
  fulldata[index[i,1],index[i,2]]=0
}
fulldata[,-c(1:5)]=log10(1+fulldata[,-c(1:5)])
index=which(fulldata$subject_accession==23)
fulldata=fulldata[-index,]
group=ifelse(fulldata$visit_name==2,1,2)
aa2=lglasso(data=fulldata[,-c(3:5)],lambda = c(0.5,0.1),group = group,random = FALSE)
aa2$wi[[1]][1:10,1:10]
aa2$wi[[2]][1:10,1:10]
```


## heterogeneous subjects

### one-stage model (post vaccination data)

```{r}
aa1=lglasso(data=postdata[,-c(3:5)],lambda = 0.005670864,random = TRUE)
aa1$wi[[1]][1:10,1:10]
```

```{r}
dd=unique(postdata[,c(1,3:5)])
boxplot(aa1$tau~dd$infant_arm)
summary(lm(aa1$tau~dd$infant_arm))
boxplot(aa1$tau~dd$delivery_mode)
summary(lm(aa1$tau~dd$delivery_mode))
boxplot(aa1$tau~dd$arm_name)
summary(lm(aa1$tau~dd$arm_name))
```



### two-stage model (full data)

```{r}
aa2=lglasso(data=fulldata[,-c(3:5)],lambda = c(0.5,0.1),group = group,random = TRUE)
aa2$wi[[1]][1:10,1:10]
aa2$wi[[2]][1:10,1:10]
```

```{r}
dd=unique(fulldata[,c(1,3:5)])
boxplot(aa2$tau~dd$infant_arm)
summary(lm(aa2$tau~dd$infant_arm))
boxplot(aa2$tau~dd$delivery_mode)
summary(lm(aa2$tau~dd$delivery_mode))
boxplot(aa2$tau~dd$arm_name)
summary(lm(aa2$tau~dd$arm_name))
```

